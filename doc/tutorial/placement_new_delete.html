<!DOCTYPE html>
<html>
<head>
<title>Placement New and Delete</title>
<meta name="generator" content="Bluefish 2.2.10" >
<meta name="copyright" content="">
<meta name="keywords" content="">
<meta name="description" content="">
<meta name="ROBOTS" content="NOINDEX, NOFOLLOW">
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8">
<meta http-equiv="content-style-type" content="text/css">
<meta http-equiv="expires" content="0">
<link href="yaooc.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="yaooc.js"></script>
</head>
<body>
<div id="wrapper">
<script>header();</script>
<script>menu();</script>
<div id="content" class="content">
<div style="overflow-y: scroll; height:900px">
<h2>Placement New and Delete</h2>

<p>
In the previous chapter, static objects were introduced.  This chapter will introduce placement new to initialize
static objects and a placement delete to destroy these objects. 
Note that C++ does not provide a placement delete but can be simulated by directly calling the destructor (ptr->~T()).
</p>
<div class="divTable">
<div class="divTableBody">
<div class="divTableRow">
<div class="divTableHead">Purpose</div>
<div class="divTableHead">C++</div>
<div class="divTableHead">YAOOC</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Initialize the single object at ptr of type T using default constructor</div>
<div class="divTableCell">new (ptr) T;</div>
<div class="divTableCell">newp(ptr,T);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Initialize array of n objects at ptr of type T</div>
<div class="divTableCell">new (ptr) T[n];</div>
<div class="divTableCell">newp_array(ptr,T,n);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Initialize new object from existing dynamically allocated object (copy constructor)<br>
Use newp_copy_static (below) to initialize from static object
</div>
<div class="divTableCell">new (ptr) T(ref);</div>
<div class="divTableCell">newp_copy(dst_ptr,src_ptr);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Initialize new object from existing static object</div>
<div class="divTableCell">new (ptr) T(ref);</div>
<div class="divTableCell">newp_copy_static(dst_ptr,src_ptr);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Initialize n new objects from existing dynamically allocated object (copy constructor)</div>
<div class="divTableCell">N/A</div>
<div class="divTableCell">newp_array_copy(dst_ptr,src_ptr,n);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Initialize n new objects from existing static object (copy constructor)</div>
<div class="divTableCell">N/A</div>
<div class="divTableCell">newp_array_copy_static(dst_ptr,src_ptr,T,n);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Initialize new object using specified constructor to initialize the object</div>
<div class="divTableCell">new (ptr) T(args);</div>
<div class="divTableCell">newp_ctor(ptr,T,ctor,args);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Initialize n new objects using specified constructor to initialize each object</div>
<div class="divTableCell">N/A</div>
<div class="divTableCell">newp_array_ctor(ptr,T,n,ctor,args);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Destory single object of type T</div>
<div class="divTableCell">N/A</div>
<div class="divTableCell">deletep(ptr,T);</div>
</div>
<div class="divTableRow">
<div class="divTableCell">Destory array N objects of type T</div>
<div class="divTableCell">N/A</div>
<div class="divTableCell">deletep_array(ptr,T,N);</div>
</div>

</div>
</div>

<p>
Placement new can be used to initialize objects declared on the stack and deletep can be used to destroy these objects. For example:
</p>
<pre><code>
  my_string_t mys1;  /* Note that the "_t" is used */
  newp(&mys1,my_string);
  my_string_t mys2;
  newp_ctor(&mys2,my_string,my_string_ctor_ccs,"This is a test");
  assign_static(&mys1,&mys2,my_string);
  deletep(&mys1,my_string);
  deletep(&mys2,my_string);
</code></pre>
<p>
Variables declared on the stack can be manually initialized (rather than using newp) by assigning values to members of the class -- including the class table.
</p>
<pre><code>
  my_string_t mys1 = { .class_table_=&my_string_class_table, .str = NULL };
</code></pre>
<h3>Static object in streams</h3>
<p>
Streams use dynamically allocated objects.  As mentioned in the memory layout chapter, the type info for dynamically allocated objects is readily 
available.  This information is used by the stream class.  For POD and static objects, the type info has to be added to the stream.
The macros below facilitate streams handing reading POD and static objects properly.
</p>


<div class="divTable">
<div class="divTableBody">
<div class="divTableRow">
<div class="divTableHead">Macro</div>
<div class="divTableHead">Description</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_OBJ(O,T)</div>
<div class="divTableCell">Input static object O of type T</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_CHR(ch)</div>
<div class="divTableCell">Input single character</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_UCHR(uch)</div>
<div class="divTableCell">Input single unsigned character</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_SHORT(s)</div>
<div class="divTableCell">Input short</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_USHORT(us)</div>
<div class="divTableCell">Input unsigned short</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_INT(i)</div>
<div class="divTableCell">Input integer</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_UINT(ui)</div>
<div class="divTableCell">Input unsigned integer</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_LONG(l)</div>
<div class="divTableCell">Input long</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_ULONG(ul)</div>
<div class="divTableCell">Input unsigned long</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_DBL(d)</div>
<div class="divTableCell">Input double</div>
</div>
<div class="divTableRow">
<div class="divTableCell">I_CCS(ccs)</div>
<div class="divTableCell">Input character string</div>
</div>
</div>
</div>

<p>
For writing POD and static objects to streams, use "O_" rather than "I_" for macros in above table.
</p>

</div>
</div>
</div>
</body>
</html>